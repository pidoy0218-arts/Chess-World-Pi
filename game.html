<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>CHESS ARENA for PI — Blitz 60s | FIDE Legal</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
:root{ --bg:#111; --fg:#eee; --light:#f0f0f0; --dark:#b1e59f; --sel:#ffcc00; --hint:#5ac8fa; --accent:#f4b400; --warn:#ff5252 }
body{ margin:0; background:var(--bg); color:var(--fg); font-family:system-ui,Arial; display:flex;flex-direction:column;align-items:center;padding:16px; }
h1{margin:6px 0 2px;font-size:20px;text-align:center;}
.sub{opacity:.75;font-size:12px;margin-bottom:8px;text-align:center;}
#piId{font-weight:700; margin-bottom:8px; text-align:center;}
.wrap{display:flex;gap:18px;flex-wrap:wrap;align-items:flex-start;justify-content:center;width:100%;max-width:1100px}
#board{ display:grid; grid-template-columns:repeat(8,min(10.5vw,66px)); grid-template-rows:repeat(8,min(10.5vw,66px)); border:6px solid #333; border-radius:10px; overflow:hidden; box-shadow:0 8px 24px rgba(0,0,0,.45); }
.sq{ display:flex;align-items:center;justify-content:center;font-size:min(8vw,50px);cursor:pointer; transition: background 0.2s;}
.sq.light{ background:var(--light); } .sq.dark{ background:var(--dark); }
.piece.white{ color:#fff; text-shadow:1px 1px 2px #000,0 0 5px #eee; font-weight:900; transition: transform 0.2s;}
.piece.black{ color:#111; text-shadow:1px 1px 3px #555; transition: transform 0.2s;}
.sq.sel{ outline:3px solid var(--sel); outline-offset:-3px }
.sq.hint::after{ content:""; width:22%; height:22%; border-radius:50%; background:var(--hint); opacity:.85; display:block; }
.sq.cap{ box-shadow: inset 0 0 0 4px var(--warn); }
.side{ min-width:260px; max-width:360px; display:flex; flex-direction:column; gap:10px }
.panel{ background:#1b1b1b; border:1px solid #2b2b2b; border-radius:10px; padding:10px 12px }
.row{ display:flex; justify-content:space-between; align-items:center; gap:10px }
.btn{ padding:10px 12px; border-radius:8px; border:0; color:#111; background:var(--accent); font-weight:700; cursor:pointer; transition: background 0.2s;}
.btn:hover{ background:#ffdd33; }
.tiny{ font-size:12px; opacity:.8 }
.moves{ font-family:ui-monospace,Menlo,Consolas,monospace; font-size:13px; line-height:1.45; max-height:260px; overflow:auto; background:#111; padding:6px; border-radius:6px; }
.modal{ position:fixed; inset:0; background:rgba(0,0,0,.55); display:none; align-items:center; justify-content:center; z-index:10 }
.modal.show{ display:flex }
.card{ background:#1e1e1e; border:1px solid #2d2d2d; padding:16px; border-radius:12px; min-width:260px }
.grid4{ display:grid; grid-template-columns:repeat(4,1fr); gap:10px; margin-top:10px }
.pick{ font-size:34px; padding:10px; border-radius:10px; border:1px solid #333; background:#121212; color:#fff; cursor:pointer; transition: transform 0.2s; }
.pick:hover{ transform: scale(1.2); }
#fx{ position:fixed; inset:0; pointer-events:none; z-index:9 }
</style>
</head>
<body>
<h1>♞ CHESS ARENA for PI</h1>
<div class="sub">FIDE-legal: castling • en passant • promotion • check/checkmate • auto-queen promotion</div>
<div id="piId">Logged in as: —</div>

<div class="wrap">
  <div id="board" aria-label="chessboard"></div>

  <div class="side">
    <!-- Timer Panel -->
    <div class="panel row" style="justify-content:space-between; margin-bottom:8px;">
      <div><b>White:</b> <span id="timerWhite">01:00</span></div>
      <div><b>Black:</b> <span id="timerBlack">01:00</span></div>
    </div>

    <!-- Status Panel -->
    <div class="panel">
      <div class="row">
        <div id="status" style="font-weight:700">White to move</div>
        <div id="incheck" style="display:none;padding:4px 8px;border-radius:8px;background:#2b2b2b">Check!</div>
      </div>
      <div class="row tiny"><div>Castling: <span id="cr">KQkq</span></div><div>En Passant: <span id="ep">—</span></div></div>
    </div>

    <!-- Move list -->
    <div class="panel">
      <div class="row"><div><b>Move List</b></div><button class="btn" id="undoBtn" title="Undo last move">Undo</button></div>
      <div id="moves" class="moves"></div>
    </div>

    <!-- Controls -->
    <div class="panel row">
      <button class="btn" id="resetBtn">Reset</button>
      <button class="btn" id="flipBtn">Flip</button>
      <div class="tiny">Click a piece → click a target square</div>
    </div>
  </div>
</div>

<div id="promo" class="modal" role="dialog" aria-modal="true">
  <div class="card">
    <div style="font-weight:700;margin-bottom:6px">Promote pawn to:</div>
    <div class="grid4">
      <button class="pick" data-piece="q">♛</button>
      <button class="pick" data-piece="r">♜</button>
      <button class="pick" data-piece="b">♝</button>
      <button class="pick" data-piece="n">♞</button>
    </div>
  </div>
</div>

<canvas id="fx"></canvas>

<script>
/* ------------------ Config ------------------ */
const AUTO_PROMOTE = true; 
let timerWhite=60, timerBlack=60, firstMoveMade=false, timerInterval=null;

/* ---------------- Sound ---------------- */
const SND = (() => {
  let ctx;
  function beep(freq=600,dur=0.08,type='square',vol=0.05){
    try{ ctx=ctx||new(window.AudioContext||window.webkitAudioContext)(); const o=ctx.createOscillator(),g=ctx.createGain(); o.type=type;o.frequency.value=freq;g.gain.value=vol;o.connect(g);g.connect(ctx.destination);o.start();setTimeout(()=>o.stop(),dur*1000);}catch(e){}
  }
  return {
    move:()=>beep(640,0.07,'square',0.05),
    capture:()=>{beep(220,0.05,'sawtooth',0.06); setTimeout(()=>beep(180,0.09,'sawtooth',0.05),60);},
    check:()=>beep(900,0.12,'triangle',0.06),
    win:()=>{ [880,988,1175].forEach((f,i)=>setTimeout(()=>beep(f,0.12,'triangle',0.08), i*120)); }
  };
})();

/* ---------------- Confetti ---------------- */
const Confetti = (() => {
  const c=document.getElementById('fx'),x=c.getContext('2d'); let parts=[],run=false,w=0,h=0;
  function resize(){w=c.width=innerWidth;h=c.height=innerHeight;}
  addEventListener('resize',resize); resize();
  function burst(n=120){parts=[];for(let i=0;i<n;i++) parts.push({x:w/2,y:h*0.25,vx:(Math.random()*2-1)*6,vy:(Math.random()*-6-2),g:Math.random()*0.18+0.12,s:Math.random()*6+3,a:Math.random()*Math.PI,col:`hsl(${Math.random()*360},90%,60%)`}); if(!run){run=true;requestAnimationFrame(loop);}}
  function loop(){x.clearRect(0,0,w,h); for(const p of parts){p.vy+=p.g;p.x+=p.vx;p.y+=p.vy;p.a+=0.2;x.save();x.translate(p.x,p.y);x.rotate(p.a);x.fillStyle=p.col;x.fillRect(-p.s/2,-p.s/2,p.s,p.s);x.restore();} parts=parts.filter(p=>p.y<h+30); if(parts.length) requestAnimationFrame(loop);else run=false;}
  return { burst };
})();

/* ----------------- Utilities ----------------- */
const U={ inBounds:(r,c)=>r>=0&&r<8&&c>=0&&c<8, clone:(o)=>JSON.parse(JSON.stringify(o)), toAlg:(r,c)=>"abcdefgh"[c]+(8-r), fromAlg:(a)=>({r:8-parseInt(a[1],10),c:"abcdefgh
