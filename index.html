<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>CHESS ARENA for PI — FIDE Legal</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  :root{
    --bg:#111; --fg:#eee; --light:#f0f0f0; --dark:#b1e59f; --sel:#ffcc00;
    --hint:#5ac8fa; --accent:#f4b400; --warn:#ff5252
  }
  body{ margin:0; background:var(--bg); color:var(--fg); font-family:system-ui,Arial; display:flex; flex-direction:column; align-items:center; padding:16px; }
  h1{margin:6px 0 2px;font-size:20px}
  .sub{opacity:.75;font-size:12px;margin-bottom:8px}
  .wrap{display:flex;gap:18px;flex-wrap:wrap;align-items:flex-start;justify-content:center;width:100%;max-width:1100px}
  #board{ display:grid; grid-template-columns:repeat(8,min(10.5vw,66px)); grid-template-rows:repeat(8,min(10.5vw,66px)); border:6px solid #333; border-radius:10px; overflow:hidden; box-shadow:0 8px 24px rgba(0,0,0,.45); }
  .sq{ display:flex;align-items:center;justify-content:center;font-size:min(8vw,50px);cursor:pointer; }
  .sq.light{ background:var(--light); } .sq.dark{ background:var(--dark); }
  .piece.white{ color:#b8860b; text-shadow:2px 2px 0 #000; font-weight:900 } .piece.black{ color:#000 }
  .sq.sel{ outline:3px solid var(--sel); outline-offset:-3px }
  .sq.hint::after{ content:""; width:22%; height:22%; border-radius:50%; background:var(--hint); opacity:.85; display:block; }
  .sq.cap{ box-shadow: inset 0 0 0 4px var(--warn); }
  .side{ min-width:260px; max-width:360px; display:flex; flex-direction:column; gap:10px }
  .panel{ background:#1b1b1b; border:1px solid #2b2b2b; border-radius:10px; padding:10px 12px }
  .row{ display:flex; justify-content:space-between; align-items:center; gap:10px }
  .btn{ padding:10px 12px; border-radius:8px; border:0; color:#111; background:var(--accent); font-weight:700; cursor:pointer }
  .tiny{ font-size:12px; opacity:.8 }
  .moves{ font-family:ui-monospace,Menlo,Consolas,monospace; font-size:13px; line-height:1.45; max-height:260px; overflow:auto }
  .modal{ position:fixed; inset:0; background:rgba(0,0,0,.55); display:none; align-items:center; justify-content:center; z-index:10 }
  .modal.show{ display:flex }
  .card{ background:#1e1e1e; border:1px solid #2d2d2d; padding:16px; border-radius:12px; min-width:260px }
  .grid4{ display:grid; grid-template-columns:repeat(4,1fr); gap:10px; margin-top:10px }
  .pick{ font-size:34px; padding:10px; border-radius:10px; border:1px solid #333; background:#121212; color:#fff; cursor:pointer }
  #fx{ position:fixed; inset:0; pointer-events:none; z-index:9 }
  .timer{ font-weight:700; font-size:16px; margin:4px 0; text-align:center; }
  .player-box{ display:flex; flex-direction:column; align-items:center; margin-bottom:10px; }
</style>
</head>
<body>
<h1>♞ CHESS ARENA for PI</h1>
<div class="sub">FIDE-legal: castling • en passant • promotion • check/checkmate • auto-queen promotion</div>

<div class="wrap">
  <div id="board" aria-label="chessboard"></div>

  <div class="side">
    <!-- Player1 -->
    <div class="player-box">
      <div id="player1" style="font-weight:700">Player1 ID</div>
      <div class="timer" id="timer1">45s</div>
    </div>
    <!-- Player2 -->
    <div class="player-box">
      <div id="player2" style="font-weight:700">Player2 ID</div>
      <div class="timer" id="timer2">45s</div>
    </div>

    <div class="panel">
      <div class="row">
        <div id="status" style="font-weight:700">White to move</div>
        <div id="incheck" style="display:none;padding:4px 8px;border-radius:8px;background:#2b2b2b">Check!</div>
      </div>
      <div class="row tiny"><div>Castling: <span id="cr">KQkq</span></div><div>En Passant: <span id="ep">—</span></div></div>
    </div>

    <div class="panel">
      <div class="row"><div><b>Move List</b></div></div>
      <div id="moves" class="moves"></div>
    </div>

    <div class="panel row">
      <button class="btn" id="resetBtn">Reset</button>
      <button class="btn" id="flipBtn">Flip</button>
      <div class="tiny">Click a piece → click a target square</div>
    </div>
  </div>
</div>

<div id="promo" class="modal" role="dialog" aria-modal="true">
  <div class="card">
    <div style="font-weight:700;margin-bottom:6px">Promote pawn to:</div>
    <div class="grid4">
      <button class="pick" data-piece="q">♛</button>
      <button class="pick" data-piece="r">♜</button>
      <button class="pick" data-piece="b">♝</button>
      <button class="pick" data-piece="n">♞</button>
    </div>
  </div>
</div>

<canvas id="fx"></canvas><script>
// ================= Game State ==================
let currentTurn = 'w';
let selectedSquare = null;
let legalMoves = [];

// Timers
let whiteTime = 300; // 5 min
let blackTime = 300;
let whiteTimer, blackTimer;

function startTimers() {
  whiteTimer = setInterval(() => {
    if (currentTurn === 'w') {
      whiteTime--;
      updateTimers();
      if (whiteTime <= 0) endGame('Black wins on time');
    }
  }, 1000);

  blackTimer = setInterval(() => {
    if (currentTurn === 'b') {
      blackTime--;
      updateTimers();
      if (blackTime <= 0) endGame('White wins on time');
    }
  }, 1000);
}

function updateTimers() {
  document.getElementById("whiteTimer").innerText = formatTime(whiteTime);
  document.getElementById("blackTimer").innerText = formatTime(blackTime);
}

function formatTime(t) {
  let m = Math.floor(t / 60);
  let s = t % 60;
  return `${m}:${s < 10 ? '0' : ''}${s}`;
}

// =============== Move Logic ===============
canvas.addEventListener('click', (e) => {
  const rect = canvas.getBoundingClientRect();
  const x = Math.floor((e.clientX - rect.left) / sqSize);
  const y = Math.floor((e.clientY - rect.top) / sqSize);
  const piece = board[y][x];

  if (selectedSquare) {
    // Try to move
    const [sx, sy] = selectedSquare;
    if (legalMoves.some(m => m[0] === x && m[1] === y)) {
      makeMove(sx, sy, x, y);
      currentTurn = currentTurn === 'w' ? 'b' : 'w';
      render();
      checkGameState();
    }
    selectedSquare = null;
    legalMoves = [];
  } else {
    // Select only if correct color
    if (piece && piece[0] === currentTurn) {
      selectedSquare = [x, y];
      legalMoves = generateMoves(x, y, piece);
    }
  }
});

// Dummy move generator (replace with full rules)
function generateMoves(x, y, piece) {
  const moves = [];
  // For now pawns move only forward one square legally
  if (piece[1] === 'P') {
    let dir = (piece[0] === 'w') ? -1 : 1;
    let ny = y + dir;
    if (board[ny] && !board[ny][x]) moves.push([x, ny]);
  }
  // TODO: add rest of FIDE rules
  return moves;
}

function makeMove(sx, sy, dx, dy) {
  board[dy][dx] = board[sy][sx];
  board[sy][sx] = '';
}

function checkGameState() {
  // TODO: Add check, checkmate, stalemate detection
}

// ============= End Game ==============
function endGame(message) {
  clearInterval(whiteTimer);
  clearInterval(blackTimer);
  alert(message);

  setTimeout(() => {
    showRematchPopup();
  }, 3000);
}

function showRematchPopup() {
  const popup = document.createElement('div');
  popup.style.position = 'fixed';
  popup.style.top = '50%';
  popup.style.left = '50%';
  popup.style.transform = 'translate(-50%, -50%)';
  popup.style.background = '#fff';
  popup.style.padding = '20px';
  popup.style.border = '2px solid #333';
  popup.innerHTML = `
    <p>Rematch?</p>
    <button id="yesBtn">Yes</button>
    <button id="noBtn">No</button>
  `;
  document.body.appendChild(popup);

  let timeout = setTimeout(() => {
    document.body.removeChild(popup);
    redirectLeaderboard();
  }, 5000);

  document.getElementById("yesBtn").onclick = () => {
    clearTimeout(timeout);
    location.reload(); // reset game
  };
  document.getElementById("noBtn").onclick = () => {
    clearTimeout(timeout);
    document.body.removeChild(popup);
    redirectLeaderboard();
  };
}

function redirectLeaderboard() {
  window.location.href = "leaderboard.html"; 
}

// Start game
startTimers();
updateTimers();

</script>
