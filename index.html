<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>CHESS ARENA for PI — FIDE Legal (Auto-Queen Promotion)</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
:root{--bg:#111;--fg:#eee;--light:#f0f0f0;--dark:#b1e59f;--sel:#ffcc00;--hint:#5ac8fa;--accent:#f4b400;--warn:#ff5252}
body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,Arial;display:flex;flex-direction:column;align-items:center;padding:16px}
h1{margin:6px 0 2px;font-size:20px}
.sub{opacity:.75;font-size:12px;margin-bottom:8px}
.wrap{display:flex;gap:18px;flex-wrap:wrap;align-items:flex-start;justify-content:center;width:100%;max-width:1100px}
#board{display:grid;grid-template-columns:repeat(8,min(10.5vw,66px));grid-template-rows:repeat(8,min(10.5vw,66px));border:6px solid #333;border-radius:10px;overflow:hidden;box-shadow:0 8px 24px rgba(0,0,0,.45)}
.sq{display:flex;align-items:center;justify-content:center;font-size:min(8vw,50px);cursor:pointer}
.sq.light{background:var(--light)}
.sq.dark{background:var(--dark)}
.piece.white{color:#b8860b;text-shadow:2px 2px 0 #000;font-weight:900}
.piece.black{color:#000}
.sq.sel{outline:3px solid var(--sel);outline-offset:-3px}
.sq.hint::after{content:"";width:22%;height:22%;border-radius:50%;background:var(--hint);opacity:.85;display:block}
.sq.cap{box-shadow:inset 0 0 0 4px var(--warn)}
.side{min-width:260px;max-width:360px;display:flex;flex-direction:column;gap:10px}
.panel{background:#1b1b1b;border:1px solid #2b2b2b;border-radius:10px;padding:10px 12px}
.row{display:flex;justify-content:space-between;align-items:center;gap:10px}
.btn{padding:10px 12px;border-radius:8px;border:0;color:#111;background:var(--accent);font-weight:700;cursor:pointer}
.tiny{font-size:12px;opacity:.8}
.moves{font-family:ui-monospace,Menlo,Consolas,monospace;font-size:13px;line-height:1.45;max-height:260px;overflow:auto}
.modal{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;z-index:10}
.modal.show{display:flex}
.card{background:#1e1e1e;border:1px solid #2d2d2d;padding:16px;border-radius:12px;min-width:260px}
.grid4{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-top:10px}
.pick{font-size:34px;padding:10px;border-radius:10px;border:1px solid #333;background:#121212;color:#fff;cursor:pointer}
#fx{position:fixed;inset:0;pointer-events:none;z-index:9}
</style>
</head>
<body>
<h1>♞ CHESS ARENA for PI</h1>
<div class="sub">FIDE-legal: castling • en passant • promotion • check/checkmate • auto-queen promotion</div>

<div class="wrap">
  <div id="board" aria-label="chessboard"></div>

  <div class="side">
    <div class="panel">
      <div class="row">
        <div id="player1">Player1 ID: <span>---</span></div>
        <div id="timer1">45s</div>
      </div>
      <div class="row">
        <div id="player2">Player2 ID: <span>---</span></div>
        <div id="timer2">45s</div>
      </div>
      <div class="row">
        <button class="btn" id="resignBtn">Resign</button>
        <button class="btn" id="drawBtn">Offer Draw</button>
      </div>
    </div>

    <div class="panel">
      <div class="row"><div><b>Move List</b></div></div>
      <div id="moves" class="moves"></div>
    </div>
  </div>
</div>

<div id="promo" class="modal" role="dialog" aria-modal="true">
  <div class="card">
    <div style="font-weight:700;margin-bottom:6px">Promote pawn to:</div>
    <div class="grid4">
      <button class="pick" data-piece="q">♛</button>
      <button class="pick" data-piece="r">♜</button>
      <button class="pick" data-piece="b">♝</button>
      <button class="pick" data-piece="n">♞</button>
    </div>
  </div>
</div>

<div id="rematchModal" class="modal">
  <div class="card">
    <div style="font-weight:700;text-align:center;">Offer Rematch?</div>
    <div class="grid4">
      <button id="rematchYes" class="pick">Yes</button>
      <button id="rematchNo" class="pick">No</button>
    </div>
  </div>
</div>

<canvas id="fx"></canvas>

<script>
/* ----------------- Chess Core & UI ----------------- */
// Pieces & board setup
const PIECES={r:"♜",n:"♞",b:"♝",q:"♛",k:"♚",p:"♟",R:"♖",N:"♘",B:"♗",Q:"♕",K:"♔",P:"♙"};
const START=[
  ["r","n","b","q","k","b","n","r"],
  ["p","p","p","p","p","p","p","p"],
  ["","","","","","","",""],
  ["","","","","","","",""],
  ["","","","","","","",""],
  ["","","","","",""],
  ["P","P","P","P","P","P","P","P"],
  ["R","N","B","Q","K","B","N","R"]
];
let state={board:JSON.parse(JSON.stringify(START)),side:'w',castling:{wk:true,wq:true,bk:true,bq:true},ep:null,half:0,full:1,hist:[]};
let selected=null,legal=[],pendingPromotion=null,flipped=false;
let playerTimers={w:45,b:45},timerInterval=null;

// Utility
const U={
  inBounds:(r,c)=>r>=0&&r<8&&c>=0&&c<8,
  clone:o=>JSON.parse(JSON.stringify(o)),
  toAlg:(r,c)=>"abcdefgh"[c]+(8-r),
  fromAlg:a=>({r:8-parseInt(a[1],10),c:"abcdefgh".indexOf(a[0])})
};

function isWhite(p){return p&&p===p.toUpperCase();}
function isBlack(p){return p&&p===p.toLowerCase();}
function other(side){return side==='w'?'b':'w';}

// Rendering
const boardEl=document.getElementById('board');
const timer1El=document.getElementById('timer1');
const timer2El=document.getElementById('timer2');
const movesEl=document.getElementById('moves');
const rematchModal=document.getElementById('rematchModal');
const rematchYes=document.getElementById('rematchYes');
const rematchNo=document.getElementById('rematchNo');
const promoModal=document.getElementById('promo');

function render(){
  boardEl.innerHTML='';
  for(let r=0;r<8;r++){
    for(let c=0;c<8;c++){
      const sq=document.createElement('div');
      sq.className=`sq ${(r+c)%2?'dark':'light'}`;
      sq.dataset.r=r; sq.dataset.c=c;
      const p=state.board[r][c];
      if(p){const sp=document.createElement('span');sp.textContent=PIECES[p];sp.className=`piece ${isWhite(p)?'white':'black'}`;sq.appendChild(sp);}
      if(selected && selected.r===r && selected.c===c) sq.classList.add('sel');
      boardEl.appendChild(sq);
    }
  }
}

// Simplified move logic (replace with full legalMoves for FIDE later)
boardEl.addEventListener('click',e=>{
  const sq=e.target.closest('.sq');if(!sq)return;
  const r=parseInt(sq.dataset.r),c=parseInt(sq.dataset.c);
  if(selected){state.board[r][c]=state.board[selected.r][selected.c];state.board[selected.r][selected.c]='';selected=null;render();return;}
  if(state.board[r][c] && ((state.side==='w' && isWhite(state.board[r][c])) || (state.side==='b' && isBlack(state.board[r][c])))){selected={r,c};render();}
});

function startTimers(){clearInterval(timerInterval);timerInterval=setInterval(()=>{playerTimers[state.side]--;timer1El.textContent=playerTimers.w+'s';timer2El.textContent=playerTimers.b+'s';if(playerTimers.w<=0||playerTimers.b<=0)endGame('timeout');},1000);}

// Game end + rematch
function endGame(reason){clearInterval(timerInterval);setTimeout(()=>showRematch(),3000);}
function showRematch(){rematchModal.classList.add('show');let timeout=setTimeout(()=>window.location.href='leaderboard.html',5000);rematchYes.onclick=()=>{clearTimeout(timeout);rematchModal.classList.remove('show');initGame();};rematchNo.onclick=()=>{clearTimeout(timeout);window.location.href='leaderboard.html';};}

// Controls
document.getElementById('resignBtn').onclick=()=>endGame('resign');
document.getElementById('drawBtn').onclick=()=>endGame('draw');

function initGame(){state.board=U.clone(START);state.side='w';playerTimers={w:45,b:45};render();startTimers();}

// Initial render
initGame();
</script>
</body>
</html>
