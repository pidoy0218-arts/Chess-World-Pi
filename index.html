<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>CHESS ARENA for PI — FIDE Legal (Auto-Queen Promotion)</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  :root{ --bg:#111; --fg:#eee; --light:#f0f0f0; --dark:#b1e59f; --sel:#ffcc00; --hint:#5ac8fa; --accent:#f4b400; --warn:#ff5252 }
  body{ margin:0; background:var(--bg); color:var(--fg); font-family:system-ui,Arial; display:flex;flex-direction:column;align-items:center;padding:16px; }
  h1{margin:6px 0 2px;font-size:20px}
  .sub{opacity:.75;font-size:12px;margin-bottom:8px}
  .wrap{display:flex;gap:18px;flex-wrap:wrap;align-items:flex-start;justify-content:center;width:100%;max-width:1100px}
  #board{ display:grid; grid-template-columns:repeat(8,min(10.5vw,66px)); grid-template-rows:repeat(8,min(10.5vw,66px)); border:6px solid #333; border-radius:10px; overflow:hidden; box-shadow:0 8px 24px rgba(0,0,0,.45); }
  .sq{ display:flex;align-items:center;justify-content:center;font-size:min(8vw,50px);cursor:pointer; }
  .sq.light{ background:var(--light); } .sq.dark{ background:var(--dark); }
  .piece.white{ color:#b8860b; text-shadow:2px 2px 0 #000; font-weight:900 } .piece.black{ color:#000 }
  .sq.sel{ outline:3px solid var(--sel); outline-offset:-3px }
  .sq.hint::after{ content:""; width:22%; height:22%; border-radius:50%; background:var(--hint); opacity:.85; display:block; }
  .sq.cap{ box-shadow: inset 0 0 0 4px var(--warn); }
  .side{ min-width:260px; max-width:360px; display:flex; flex-direction:column; gap:10px }
  .panel{ background:#1b1b1b; border:1px solid #2b2b2b; border-radius:10px; padding:10px 12px }
  .row{ display:flex; justify-content:space-between; align-items:center; gap:10px }
  .btn{ padding:10px 12px; border-radius:8px; border:0; color:#111; background:var(--accent); font-weight:700; cursor:pointer }
  .tiny{ font-size:12px; opacity:.8 }
  .moves{ font-family:ui-monospace,Menlo,Consolas,monospace; font-size:13px; line-height:1.45; max-height:260px; overflow:auto }
  .modal{ position:fixed; inset:0; background:rgba(0,0,0,.55); display:none; align-items:center; justify-content:center; z-index:10 }
  .modal.show{ display:flex }
  .card{ background:#1e1e1e; border:1px solid #2d2d2d; padding:16px; border-radius:12px; min-width:260px }
  .grid4{ display:grid; grid-template-columns:repeat(4,1fr); gap:10px; margin-top:10px }
  .pick{ font-size:34px; padding:10px; border-radius:10px; border:1px solid #333; background:#121212; color:#fff; cursor:pointer }
  #fx{ position:fixed; inset:0; pointer-events:none; z-index:9 }

  /* Pi SDK / player panel */
  .player-panel{ display:flex; justify-content:space-between; width:100%; max-width:360px; margin-bottom:12px; }
  .player{ background:#222; padding:6px 10px; border-radius:8px; flex:1; text-align:center; margin:0 6px; }
  .player .name{ font-weight:700; margin-bottom:4px; }
  .player .timer{ font-size:14px; color:#f4b400; }
</style>
</head>
<body>
<h1>♞ CHESS ARENA for PI</h1>
<div class="sub">FIDE-legal: castling • en passant • promotion • check/checkmate • auto-queen promotion</div>

<!-- Pi SDK player panel placeholders -->
<div class="player-panel">
  <div class="player" id="player1">
    <div class="name">Player 1 (ID)</div>
    <div class="timer" id="timer1">45s</div>
  </div>
  <div class="player" id="player2">
    <div class="name">Player 2 (ID)</div>
    <div class="timer" id="timer2">45s</div>
  </div>
</div>

<div class="wrap">
  <div id="board" aria-label="chessboard"></div>

  <div class="side">
    <div class="panel">
      <div class="row">
        <div id="status" style="font-weight:700">White to move</div>
        <div id="incheck" style="display:none;padding:4px 8px;border-radius:8px;background:#2b2b2b">Check!</div>
      </div>
      <div class="row tiny"><div>Castling: <span id="cr">KQkq</span></div><div>En Passant: <span id="ep">—</span></div></div>
    </div>

    <div class="panel">
      <div class="row"><div><b>Move List</b></div><button class="btn" id="undoBtn" title="Undo last move">Undo</button></div>
      <div id="moves" class="moves"></div>
    </div>

    <div class="panel row">
      <button class="btn" id="resetBtn">Reset</button>
      <button class="btn" id="flipBtn">Flip</button>
      <div class="tiny">Click a piece → click a target square</div>
    </div>
  </div>
</div>

<div id="promo" class="modal" role="dialog" aria-modal="true">
  <div class="card">
    <div style="font-weight:700;margin-bottom:6px">Promote pawn to:</div>
    <div class="grid4">
      <button class="pick" data-piece="q">♛</button>
      <button class="pick" data-piece="r">♜</button>
      <button class="pick" data-piece="b">♝</button>
      <button class="pick" data-piece="n">♞</button>
    </div>
  </div>
</div>

<canvas id="fx"></canvas>

<script>
/* ----------------- Board / Pieces Fix ----------------- */
const PIECES = { r:"♜", n:"♞", b:"♝", q:"♛", k:"♚", p:"♟", R:"♖", N:"♘", B:"♗", Q:"♕", K:"♔", P:"♙" };
const boardEl = document.getElementById('board');
const statusEl = document.getElementById('status');
const incheckEl = document.getElementById('incheck');
const crEl = document.getElementById('cr');
const epEl = document.getElementById('ep');
const movesEl = document.getElementById('moves');
const resetBtn = document.getElementById('resetBtn');
const flipBtn = document.getElementById('flipBtn');
const undoBtn  = document.getElementById('undoBtn');
const promoModal = document.getElementById('promo');

const START = [
  ["r","n","b","q","k","b","n","r"],
  ["p","p","p","p","p","p","p","p"],
  ["","","","","","","",""],
  ["","","","","","","",""],
  ["","","","","","","",""],
  ["","","","","","","",""],
  ["P","P","P","P","P","P","P","P"],
  ["R","N","B","Q","K","B","N","R"]
];

let state = { board: JSON.parse(JSON.stringify(START)), side:'w', castling:{wk:true,wq:true,bk:true,bq:true}, ep:null, half:0, full:1, hist:[] };

let selected = null, legal = [], flipped = false, pendingPromotion = null;

/* Helper functions */
function isWhite(p){ return p && p === p.toUpperCase(); }
function sidePiece(p, side){ return side==='w'?isWhite(p):!isWhite(p); }
function UtoAlg(r,c){ return "abcdefgh"[c]+(8-r); }
function kingPos(board,side){ for(let r=0;r<8;r++)for(let c=0;c<8;c++){if(board[r][c]=== (side==='w'?'K':'k')) return {r,c};} return null; }
function inBounds(r,c){ return r>=0 && r<8 && c>=0 && c<8; }

/* ----------------- Render Board ----------------- */
function render(){
  boardEl.innerHTML = '';
  for(let r=0;r<8;r++){
    for(let c=0;c<8;c++){
      const sq=document.createElement('div');
      sq.className='sq '+((r+c)%2?'dark':'light');
      const p=state.board[r][c];
      if(p){ const sp=document.createElement('span'); sp.textContent=PIECES[p]; sp.className='piece '+(isWhite(p)?'white':'black'); sq.appendChild(sp); }
      boardEl.appendChild(sq);
    }
  }
}
render();

/* ----------------- Pi SDK / Timer Placeholder ----------------- */
let timer1=45, timer2=45;
const t1=document.getElementById('timer1'), t2=document.getElementById('timer2');
let currentTimer = 'player1', interval = setInterval(()=>{ 
  if(currentTimer==='player1'){ timer1--; t1.textContent=timer1+'s'; if(timer1<=0) { alert('Player 1 loses by timeout'); resetTimers(); } }
  else { timer2--; t2.textContent=timer2+'s'; if(timer2<=0) { alert('Player 2 loses by timeout'); resetTimers(); } }
},1000);

function resetTimers(){ timer1=45; timer2=45; t1.textContent='45s'; t2.textContent='45s'; }

/* ----------------- Existing game logic (moves, promotion, sounds, confetti, etc.) ----------------- */
/* Place your full FIDE legal logic here from previous code. Only rendering and timers are added. */

</script>
</body>
</html>
