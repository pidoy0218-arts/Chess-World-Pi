<script>
/* ----------------- Utilities ----------------- */
function other(side){ return side === 'w' ? 'b' : 'w'; }

/* ----------------- Board Rendering ----------------- */
const boardEl = document.getElementById('board');
function renderBoard(){
  boardEl.innerHTML = '';
  for(let r=0;r<8;r++){
    for(let c=0;c<8;c++){
      const sq = document.createElement('div');
      sq.className = 'sq ' + ((r+c)%2?'dark':'light');
      sq.dataset.r = r; sq.dataset.c = c;
      const p = state.board[r][c];
      if(p){
        const piece = document.createElement('div');
        piece.className = 'piece ' + (isWhite(p)?'white':'black');
        piece.textContent = p === 'P'?'♙':
                            p === 'R'?'♖':
                            p === 'N'?'♘':
                            p === 'B'?'♗':
                            p === 'Q'?'♕':
                            p === 'K'?'♔':
                            p === 'p'?'♟':
                            p === 'r'?'♜':
                            p === 'n'?'♞':
                            p === 'b'?'♝':
                            p === 'q'?'♛':
                            p === 'k'?'♚':'';
        sq.appendChild(piece);
      }
      sq.addEventListener('click',onSquareClick);
      boardEl.appendChild(sq);
    }
  }
}
renderBoard();

/* ----------------- Move Logic ----------------- */
let sel=null;
function onSquareClick(e){
  const r = parseInt(e.currentTarget.dataset.r);
  const c = parseInt(e.currentTarget.dataset.c);
  const piece = state.board[r][c];
  if(sel){
    if(movePiece(sel.r,sel.c,r,c)){
      sel=null;
      renderBoard();
      SND.move();
      updateStatus();
    } else {
      sel=null;
      renderBoard();
    }
  } else {
    if(piece && sidePiece(piece,state.side)){
      sel={r,c};
      e.currentTarget.classList.add('sel');
    }
  }
}

function movePiece(r1,c1,r2,c2){
  const p = state.board[r1][c1];
  if(!p) return false;
  // Simplified: allow any move for demonstration
  state.board[r2][c2] = p;
  state.board[r1][c1] = '';
  state.side = other(state.side);
  state.hist.push({from:U.toAlg(r1,c1),to:U.toAlg(r2,c2)});
  addMoveToList(state.hist[state.hist.length-1]);
  return true;
}

function addMoveToList(move){
  const movesEl = document.getElementById('moves');
  const el = document.createElement('div');
  el.textContent = `${move.from} → ${move.to}`;
  movesEl.appendChild(el);
}

/* ----------------- Status & Timers ----------------- */
const whiteTimerEl = document.getElementById('whiteTimer');
const blackTimerEl = document.getElementById('blackTimer');
const statusEl = document.getElementById('status');

function updateStatus(){
  statusEl.textContent = state.side==='w'?'White to move':'Black to move';
}

function startTimers(){
  if(timerInterval) clearInterval(timerInterval);
  timerInterval = setInterval(()=>{
    timers[state.side]--;
    const mins = Math.floor(timers[state.side]/60).toString().padStart(2,'0');
    const secs = (timers[state.side]%60).toString().padStart(2,'0');
    if(state.side==='w') whiteTimerEl.textContent = `White: ${mins}:${secs}`;
    else blackTimerEl.textContent = `Black: ${mins}:${secs}`;
    if(timers[state.side]<=0){
      clearInterval(timerInterval);
      statusEl.textContent = (state.side==='w'?'White':'Black')+' lost on time!';
      SND.win();
      Confetti.burst();
    }
  },1000);
}
startTimers();

/* ----------------- Pawn Promotion ----------------- */
const promoModal = document.getElementById('promo');
document.querySelectorAll('.pick').forEach(btn=>{
  btn.addEventListener('click',e=>{
    const piece = btn.dataset.piece;
    const lastMove = state.hist[state.hist.length-1];
    if(lastMove){
      const {r:toR, c:toC} = U.fromAlg(lastMove.to);
      state.board[toR][toC] = state.side==='w'?piece.toUpperCase():piece.toLowerCase();
      promoModal.classList.remove('show');
      renderBoard();
    }
  });
});

/* ----------------- Leaderboard Placeholder ----------------- */
const leaderboard = document.getElementById('leaderboard');
// You can populate via Pi SDK later
leaderboard.innerHTML += `<option value="player1">Player 1</option><option value="player2">Player 2</option>`;

</script>
