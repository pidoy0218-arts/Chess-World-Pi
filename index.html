<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>CHESS ARENA for PI — FIDE Legal</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  :root{
    --bg:#111; --fg:#eee; --light:#f0f0f0; --dark:#b1e59f; --sel:#ffcc00;
    --hint:#5ac8fa; --accent:#f4b400; --warn:#ff5252
  }
  body{ margin:0; background:var(--bg); color:var(--fg); font-family:system-ui,Arial; display:flex; flex-direction:column; align-items:center; padding:16px; }
  h1{margin:6px 0 2px;font-size:20px}
  .sub{opacity:.75;font-size:12px;margin-bottom:8px}
  .wrap{display:flex;gap:18px;flex-wrap:wrap;align-items:flex-start;justify-content:center;width:100%;max-width:1100px}
  #board{ display:grid; grid-template-columns:repeat(8,min(10.5vw,66px)); grid-template-rows:repeat(8,min(10.5vw,66px)); border:6px solid #333; border-radius:10px; overflow:hidden; box-shadow:0 8px 24px rgba(0,0,0,.45); }
  .sq{ display:flex;align-items:center;justify-content:center;font-size:min(8vw,50px);cursor:pointer; }
  .sq.light{ background:var(--light); } .sq.dark{ background:var(--dark); }
  .piece.white{ color:#b8860b; text-shadow:2px 2px 0 #000; font-weight:900 } .piece.black{ color:#000 }
  .sq.sel{ outline:3px solid var(--sel); outline-offset:-3px }
  .sq.hint::after{ content:""; width:22%; height:22%; border-radius:50%; background:var(--hint); opacity:.85; display:block; }
  .sq.cap{ box-shadow: inset 0 0 0 4px var(--warn); }
  .side{ min-width:260px; max-width:360px; display:flex; flex-direction:column; gap:10px }
  .panel{ background:#1b1b1b; border:1px solid #2b2b2b; border-radius:10px; padding:10px 12px }
  .row{ display:flex; justify-content:space-between; align-items:center; gap:10px }
  .btn{ padding:10px 12px; border-radius:8px; border:0; color:#111; background:var(--accent); font-weight:700; cursor:pointer }
  .tiny{ font-size:12px; opacity:.8 }
  .moves{ font-family:ui-monospace,Menlo,Consolas,monospace; font-size:13px; line-height:1.45; max-height:260px; overflow:auto }
  .modal{ position:fixed; inset:0; background:rgba(0,0,0,.55); display:none; align-items:center; justify-content:center; z-index:10 }
  .modal.show{ display:flex }
  .card{ background:#1e1e1e; border:1px solid #2d2d2d; padding:16px; border-radius:12px; min-width:260px }
  .grid4{ display:grid; grid-template-columns:repeat(4,1fr); gap:10px; margin-top:10px }
  .pick{ font-size:34px; padding:10px; border-radius:10px; border:1px solid #333; background:#121212; color:#fff; cursor:pointer }
  #fx{ position:fixed; inset:0; pointer-events:none; z-index:9 }
  .timer{ font-weight:700; font-size:16px; margin:4px 0; text-align:center; }
  .player-box{ display:flex; flex-direction:column; align-items:center; margin-bottom:10px; }
</style>
</head>
<body>
<h1>♞ CHESS ARENA for PI</h1>
<div class="sub">FIDE-legal: castling • en passant • promotion • check/checkmate • auto-queen promotion</div>

<div class="wrap">
  <div id="board" aria-label="chessboard"></div>

  <div class="side">
    <!-- Player1 -->
    <div class="player-box">
      <div id="player1" style="font-weight:700">Player1 ID</div>
      <div class="timer" id="timer1">45s</div>
    </div>
    <!-- Player2 -->
    <div class="player-box">
      <div id="player2" style="font-weight:700">Player2 ID</div>
      <div class="timer" id="timer2">45s</div>
    </div>

    <div class="panel">
      <div class="row">
        <div id="status" style="font-weight:700">White to move</div>
        <div id="incheck" style="display:none;padding:4px 8px;border-radius:8px;background:#2b2b2b">Check!</div>
      </div>
      <div class="row tiny"><div>Castling: <span id="cr">KQkq</span></div><div>En Passant: <span id="ep">—</span></div></div>
    </div>

    <div class="panel">
      <div class="row"><div><b>Move List</b></div></div>
      <div id="moves" class="moves"></div>
    </div>

    <div class="panel row">
      <button class="btn" id="resetBtn">Reset</button>
      <button class="btn" id="flipBtn">Flip</button>
      <div class="tiny">Click a piece → click a target square</div>
    </div>
  </div>
</div>

<div id="promo" class="modal" role="dialog" aria-modal="true">
  <div class="card">
    <div style="font-weight:700;margin-bottom:6px">Promote pawn to:</div>
    <div class="grid4">
      <button class="pick" data-piece="q">♛</button>
      <button class="pick" data-piece="r">♜</button>
      <button class="pick" data-piece="b">♝</button>
      <button class="pick" data-piece="n">♞</button>
    </div>
  </div>
</div>

<script>
/* ----------------- Timer & Player ID placeholders ----------------- */
const player1El = document.createElement('div');
player1El.textContent = 'Player 1: [ID]';
player1El.style.fontWeight = '700';
player1El.style.marginBottom = '4px';

const player2El = document.createElement('div');
player2El.textContent = 'Player 2: [ID]';
player2El.style.fontWeight = '700';
player2El.style.marginBottom = '4px';

const timer1El = document.createElement('div');
timer1El.textContent = '45';
timer1El.style.fontWeight = '700';
timer1El.style.color = '#f4b400';
timer1El.style.marginBottom = '10px';

const timer2El = document.createElement('div');
timer2El.textContent = '45';
timer2El.style.fontWeight = '700';
timer2El.style.color = '#f4b400';
timer2El.style.marginBottom = '10px';

const sidePanels = document.querySelectorAll('.side');
sidePanels[0].prepend(timer1El);
sidePanels[0].prepend(player1El);
sidePanels[1] && sidePanels[1].prepend(timer2El, player2El); // optional second panel

let timer1 = 45, timer2 = 45, timerInterval;

/* Start timer for both players */
function startTimer(){
  clearInterval(timerInterval);
  timerInterval = setInterval(()=>{
    if(state.side === 'w'){ timer1--; timer1El.textContent = timer1; if(timer1<=0){ endGame(other(state.side)); } }
    else { timer2--; timer2El.textContent = timer2; if(timer2<=0){ endGame(other(state.side)); } }
  },1000);
}
startTimer();

/* Reset timers after each move */
function resetTimers(){
  timer1 = 45; timer2 = 45;
  timer1El.textContent = timer1; timer2El.textContent = timer2;
}

/* ----------------- Game End & Rematch ----------------- */
function endGame(winnerSide){
  clearInterval(timerInterval);
  const winnerText = winnerSide === 'w' ? 'White' : 'Black';
  statusEl.textContent = winnerText + ' wins!';
  SND.win(); Confetti.burst(140);

  setTimeout(()=>{
    const rematch = confirm('Offer rematch to same pair?');
    if(rematch){
      payAndRematch(); // placeholder for payment & auto pair
    } else {
      redirectLeaderboard();
    }
  },3000);
}

function payAndRematch(){
  // placeholder logic: detect payment
  alert('Redirecting to lobby for payment and rematch...');
  setTimeout(()=>{
    // after payment & auto-pairing, reset game
    state = { board: U.clone(START), side:'w', castling:{wk:true,wq:true,bk:true,bq:true}, ep:null, half:0, full:1, hist:[] };
    selected = null; legal = []; pendingPromotion = null;
    movesEl.innerHTML = ''; resetTimers(); render(); startTimer();
  },2000);
}

function redirectLeaderboard(){
  alert('Redirecting to leaderboard for personal best and SDK ranking...');
  // window.location.href = '/leaderboard'; // replace with actual leaderboard URL
}

/* ----------------- Square click modification to reset timers ----------------- */
function squareClick(rr,cc){
  const p = state.board[rr][cc];
  if(selected){
    const mv = legal.find(m => m.to.r === rr && m.to.c === cc);
    if(mv){
      const ok = makeMove(state, mv, false, null);
      if(ok){
        if(pendingPromotion){ render(); return; }
        logMove(mv); SND.move(); resetTimers();
        const kp = kingPos(state.board, state.side);
        if(attacked(state.board, other(state.side), kp.r, kp.c)) SND.check();
      }
      selected = null; legal = [];
      render();
      return;
    }
    if(p && sidePiece(p, state.side)){
      selected = { r: rr, c: cc };
      legal = legalMoves(state).filter(m => m.from.r === rr && m.from.c === cc);
    } else { selected = null; legal = []; }
  } else {
    if(p && sidePiece(p, state.side)){
      selected = { r: rr, c: cc };
      legal = legalMoves(state).filter(m => m.from.r === rr && m.from.c === cc);
    }
  }
  render();
}

/* ----------------- Initial draw & start ----------------- */
render();
startTimer();
</script><canvas id="fx"></canvas>
